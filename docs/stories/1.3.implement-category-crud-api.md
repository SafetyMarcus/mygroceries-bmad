# Story 1.3: Implement Category CRUD API

## Status
Ready for Review

## Story
**As a** developer,
**I want** to create API endpoints for managing `Category` data,
**so that** categories can be created, retrieved, updated, and deleted from the database.

## Acceptance Criteria
1.  A `Category` data class is defined in the `shared` module to be used by both client and server.
2.  The Ktor server exposes RESTful endpoints at a `/categories` path.
3.  The following endpoints are implemented:
    *   `POST /categories`: Creates a new category.
    *   `GET /categories`: Retrieves all categories.
    *   `GET /categories/{id}`: Retrieves a single category by its ID.
    *   `PUT /categories/{id}`: Updates an existing category.
    *   `DELETE /categories/{id}`: Deletes a category.
4.  Each endpoint correctly performs the corresponding Create, Read, Update, or Delete operation in the PostgreSQL database.
5.  Server-side validation is implemented:
    *   All category IDs must be handled as UUIDs.
    *   The `name` for a category cannot be empty.
6.  The functionality is covered by automated tests.

## Tasks / Subtasks
- [x] Define `Category` data class in `shared` module (AC: 1)
    - [x] Create `Category.kt` in `shared/src/commonMain/kotlin/com/example/mygroceries/model/` [Source: architecture/8-source-tree.md]
    - [x] Implement `id` as UUID and `name` as String [Source: architecture/4-data-models.md]
    - [x] Annotate with `@Serializable` [Source: architecture/4-data-models.md]
- [x] Implement Category repository/DAO for database operations (AC: 4)
    - [x] Create `CategoryRepository.kt` in `server/src/main/kotlin/com/example/mygroceries/db/` [Source: architecture/8-source-tree.md]
    - [x] Implement `create`, `readAll`, `readById`, `update`, `delete` functions using Exposed [Source: architecture/3-tech-stack.md]
- [x] Implement Category service layer (AC: 4)
    - [x] Create `CategoryService.kt` in `server/src/main/kotlin/com/example/mygroceries/service/`
    - [x] Inject `CategoryRepository`
    - [x] Implement business logic for CRUD operations, including validation (AC: 5)
        - [x] Validate `name` is not empty [Source: Epic 1.3 AC 5]
        - [x] Ensure IDs are handled as UUIDs [Source: Epic 1.3 AC 5]
- [x] Implement Category API routes (AC: 2, 3)
    - [x] Create `CategoryRoutes.kt` in `server/src/main/kotlin/com/example/mygroceries/routes/` [Source: architecture/8-source-tree.md]
    - [x] Define `POST /categories` endpoint for creating categories [Source: architecture/6-rest-api-spec.md]
    - [x] Define `GET /categories` endpoint for retrieving all categories [Source: architecture/6-rest-api-spec.md]
    - [x] Define `GET /categories/{id}` endpoint for retrieving a single category by ID [Source: architecture/6-rest-api-spec.md]
    - [x] Define `PUT /categories/{id}` endpoint for updating an existing category [Source: architecture/6-rest-api-spec.md]
    - [x] Define `DELETE /categories/{id}` endpoint for deleting a category [Source: architecture/6-rest-api-spec.md]
    - [x] Handle request/response serialization using Kotlinx Serialization [Source: architecture/3-tech-stack.md]
- [x] Add unit tests for `CategoryService` (AC: 6)
    - [x] Use Kotest and MockK [Source: architecture/9-test-strategy-and-standards.md]
    - [x] Cover validation logic [Source: Epic 1.3 AC 5]
- [x] Add integration tests for Category API endpoints (AC: 6)
    - [x] Spin up in-memory Ktor application [Source: architecture/9-test-strategy-and-standards.md]
    - [x] Test all CRUD endpoints (`POST`, `GET`, `PUT`, `DELETE`) [Source: architecture/6-rest-api-spec.md]
    - [x] Verify database state changes [Source: architecture/9-test-strategy-and-standards.md]

## Dev Notes
- **Previous Story Insights**:
    - Database schema and connection are set up.
    - Monorepo structure with `shared`, `server`, `web`, `android`, and `ios` modules created.
    - Core dependencies (Ktor, Compose Multiplatform, PostgreSQL driver, Kotlinx Serialization) added and resolved.
    - `shared` module dependencies: Kotlinx Serialization, Ktor Client, Compose Multiplatform.
    - `server` module dependencies: `shared` module, Ktor Server, Exposed (DB driver), PostgreSQL.
- **Data Models**:
    - `Category`: `id`: UUID, `name`: String. One-to-Many with `Products`. [Source: architecture/4-data-models.md]
    - To be implemented as `@Serializable` data class in the `shared` module. [Source: architecture/4-data-models.md]
- **API Specifications**:
    - Ktor server exposes RESTful endpoints at `/categories`. [Source: architecture/6-rest-api-spec.md]
    - Endpoints: `GET /categories`, `POST /categories`, `GET /categories/{id}`, `PUT /categories/{id}`, `DELETE /categories/{id}`. [Source: architecture/6-rest-api-spec.md]
- **Component Specifications**: No specific guidance found in architecture docs.
- **File Locations**:
    - `Category` data class: `shared/src/commonMain/kotlin/com/example/mygroceries/model/` [Source: architecture/8-source-tree.md]
    - API route definitions: `server/src/main/kotlin/com/example/mygroceries/routes/` [Source: architecture/8-source-tree.md]
    - Database connection, migrations, repositories: `server/src/main/kotlin/com/example/mygroceries/db/` [Source: architecture/8-source-tree.md]
- **Technical Constraints**:
    - Language: Kotlin 1.9.23 [Source: architecture/3-tech-stack.md]
    - Core Framework: Kotlin Multiplatform 1.6.10 [Source: architecture/3-tech-stack.md]
    - Backend Framework: Ktor 2.3.9 [Source: architecture/3-tech-stack.md]
    - Database: PostgreSQL 15.x [Source: architecture/3-tech-stack.md]
    - Database Driver: Exposed 0.49.0 [Source: architecture/3-tech-stack.md]
    - Serialization: Kotlinx Serialization 1.6.3 [Source: architecture/3-tech-stack.md]

## Testing
- **Test file location**: Within each module's `commonTest` or `test` source set. [Source: architecture/9-test-strategy-and-standards.md]
- **Test standards**: All business logic in the `server` module must be covered by unit tests. All API endpoints defined in Epic 1 must have corresponding integration tests. [Source: architecture/9-test-strategy-and-standards.md]
- **Testing frameworks and patterns to use**: Kotest for assertions, MockK for mocking dependencies. Integration tests will spin up an in-memory or Testcontainers instance of the Ktor application and make real HTTP requests to the endpoints, asserting the responses and database state changes. [Source: architecture/9-test-strategy-and-standards.md]
- **Any specific testing requirements for this story**: Unit and integration tests for Category CRUD API.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-25 | 1.0 | Initial draft of Story 1.3 | Bob (Scrum Master) |
| 2025-10-25 | 1.1 | QA of 1.3 | QA |
| 2025-10-25 | 1.2 | Addressed QA findings: Clarified DOC-001 and DOC-002, noted SEC-001, and implemented TEST-001 by adding UUID handling verification to integration tests. | James (Dev) |

## Dev Agent Record
### Agent Model Used
Gemini

### Debug Log References
- `gradlew test` output (successful run after fixes)

### Completion Notes List
- **DOC-001 (medium): Missing `coding-standards.md` document.**
    - Resolution: Confirmed `docs/architecture/coding-standards.md` exists and satisfies this requirement.
- **DOC-002 (medium): Missing `unified-project-structure.md` document.**
    - Resolution: Confirmed `docs/architecture/source-tree.md` exists and serves this purpose.
- **SEC-001 (low): Access control for CRUD operations should be considered.**
    - Resolution: Acknowledged as a future consideration, no code changes implemented.
- **TEST-001 (low): Explicit UUID handling verification in integration tests is not explicitly stated.**
    - Resolution: Added a new test case `category table handles UUID primary keys correctly()` to `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/server/db/DatabaseIntegrationTest.kt` to verify native UUID handling. The previous compilation issue with the `uuid` extension function was resolved by removing an unnecessary import, confirming that `uuid` is available directly from the core Exposed `Table` import.

### File List
- `mygroceries/shared/src/commonMain/kotlin/com/safetymarcus/mygroceries/model/Category.kt`
- `mygroceries/server/src/main/kotlin/com/safetymarcus/mygroceries/db/CategoryRepository.kt`
- `mygroceries/server/src/main/kotlin/com/safetymarcus/mygroceries/service/CategoryService.kt`
- `mygroceries/server/src/main/kotlin/com/safetymarcus/mygroceries/routes/CategoryRoutes.kt`
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/service/CategoryServiceTest.kt`
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/db/TestDatabaseFactory.kt`
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/routes/CategoryRoutesTest.kt`
- `mygroceries/server/build.gradle.kts` (modified)
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/server/db/DatabaseIntegrationTest.kt` (modified)

## QA Results

### Review Date: 2025-10-25

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The architecture follows a layered approach (routes -> service -> repository -> db), which is a good practice. The use of Kotlin, Ktor, Exposed, and Kotlinx Serialization aligns with the project's stated tech stack. The story explicitly mentions unit tests for `CategoryService` and integration tests for API endpoints, which is a sound testing strategy. The use of Kotest and MockK for testing frameworks is appropriate. Validation logic for `name` (not empty) and `id` (UUID) is mentioned, which is crucial for data integrity. The `Dev Agent Record` also clarifies that `coding-standards.md` and `source-tree.md` exist and satisfy these requirements.

### Refactoring Performed

None.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓
- All ACs Met: ✓

### Improvements Checklist

- [ ] Consider extracting validation logic to separate validator class
- [ ] Add integration test for error scenarios

### Security Review

No specific security concerns identified from the story description. However, access control for CRUD operations should be considered (SEC-001).

### Performance Considerations

No specific performance considerations identified from the story description.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.3-implement-category-crud-api.yml
Risk profile: qa.qaLocation/assessments/1.3-risk-20251025.md (Not generated in this review)
NFR assessment: qa.qaLocation/assessments/1.3-nfr-20251025.md (Not generated in this review)

### Recommended Status

✗ Changes Required - See unchecked items above.
