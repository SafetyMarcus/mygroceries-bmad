# Story 1.4: Implement Product CRUD API

## Status
Reaady

## Story
**As a** developer,
**I want** to create API endpoints for managing `Product` data,
**so that** products can be created, retrieved, updated, and deleted from the database.

## Acceptance Criteria
1.  A `Product` data class is defined in the `shared` module. It must include a field for its associated `categoryId`.
2.  The Ktor server exposes RESTful endpoints at a `/products` path.
3.  The following endpoints are implemented:
    *   `POST /products`: Creates a new product.
    *   `GET /products`: Retrieves all products.
    *   `GET /products/{id}`: Retrieves a single product by its ID.
    *   `PUT /products/{id}`: Updates an existing product.
    *   `DELETE /products/{id}`: Deletes a product.
4.  Each endpoint correctly performs the corresponding Create, Read, Update, or Delete operation in the PostgreSQL database.
5.  Server-side validation is implemented:
    *   All product IDs must be handled as UUIDs.
    *   The `name` for a product cannot be empty.
    *   The `categoryId` provided when creating or updating a product must correspond to an existing category in the database.
6.  The functionality is covered by automated tests.

## Tasks / Subtasks
- [ ] Define `Product` data class in `shared` module (AC: 1)
    - [ ] Create `Product.kt` in `shared/src/commonMain/kotlin/com/example/mygroceries/model/` [Source: architecture/8-source-tree.md]
    - [ ] Implement `id` (UUID), `name` (String), and `categoryId` (UUID) [Source: architecture/4-data-models.md]
    - [ ] Annotate with `@Serializable` [Source: architecture/4-data-models.md]
- [ ] Implement Product repository/DAO for database operations (AC: 4)
    - [ ] Create `ProductRepository.kt` in `server/src/main/kotlin/com/example/mygroceries/db/` [Source: architecture/8-source-tree.md]
    - [ ] Implement `create`, `readAll`, `readById`, `update`, `delete` functions using Exposed [Source: architecture/3-tech-stack.md]
    - [ ] Ensure proper foreign key relationship with `categories` table [Source: architecture/7-database-schema.md]
- [ ] Implement Product service layer (AC: 4, 5)
    - [ ] Create `ProductService.kt` in `server/src/main/kotlin/com/example/mygroceries/service/`
    - [ ] Inject `ProductRepository` and `CategoryRepository`
    - [ ] Implement business logic for CRUD operations, including validation:
        - [ ] Validate `name` is not empty [Source: Epic 1.4 AC 5]
        - [ ] Ensure IDs are handled as UUIDs [Source: Epic 1.4 AC 5]
        - [ ] Validate `categoryId` exists in database [Source: Epic 1.4 AC 5]
- [ ] Implement Product API routes (AC: 2, 3)
    - [ ] Create `ProductRoutes.kt` in `server/src/main/kotlin/com/example/mygroceries/routes/` [Source: architecture/8-source-tree.md]
    - [ ] Define `POST /products` endpoint for creating products [Source: architecture/6-rest-api-spec.md]
    - [ ] Define `GET /products` endpoint for retrieving all products [Source: architecture/6-rest-api-spec.md]
    - [ ] Define `GET /products/{id}` endpoint for retrieving a single product by ID [Source: architecture/6-rest-api-spec.md]
    - [ ] Define `PUT /products/{id}` endpoint for updating an existing product [Source: architecture/6-rest-api-spec.md]
    - [ ] Define `DELETE /products/{id}` endpoint for deleting a product [Source: architecture/6-rest-api-spec.md]
    - [ ] Handle request/response serialization using Kotlinx Serialization [Source: architecture/3-tech-stack.md]
- [ ] Add unit tests for `ProductService` (AC: 6)
    - [ ] Use Kotest and MockK [Source: architecture/9-test-strategy-and-standards.md]
    - [ ] Cover validation logic [Source: Epic 1.4 AC 5]
- [ ] Add integration tests for Product API endpoints (AC: 6)
    - [ ] Test successful CRUD operations [Source: architecture/9-test-strategy-and-standards.md]
    - [ ] Test validation error cases [Source: Epic 1.4 AC 5]
    - [ ] Test not found scenarios [Source: architecture/9-test-strategy-and-standards.md]
- [ ] Update API documentation (if applicable) [Source: architecture/6-rest-api-spec.md]

## Dev Notes
- **Previous Story Insights**:
    - Database schema and connection are already set up with `products` table [Source: Story 1.2]
    - Category CRUD API is implemented and can be used for validation [Source: Story 1.3]
    - Project structure and build configuration are in place [Source: Story 1.1]

- **Data Models**:
    - `Product` model with `id` (UUID), `name` (String), and `categoryId` (UUID) [Source: architecture/4-data-models.md]
    - Many-to-One relationship with `Category` [Source: architecture/4-data-models.md]
    - Part of One-to-Many relationship with `LineItem` (future implementation) [Source: architecture/4-data-models.md]

- **API Specifications**:
    - Base path: `/products` [Source: architecture/6-rest-api-spec.md]
    - Endpoints:
        - `POST /products` - Create a new product
        - `GET /products` - Get all products
        - `GET /products/{id}` - Get a single product by ID
        - `PUT /products/{id}` - Update an existing product
        - `DELETE /products/{id}` - Delete a product

- **Component Specifications**:
    - `Product` data class in shared module
    - `ProductRepository` in server module for database operations
    - `ProductService` for business logic and validation
    - `ProductRoutes` for API endpoint definitions

- **File Locations**:
    - `Product` data class: `shared/src/commonMain/kotlin/com/example/mygroceries/model/` [Source: architecture/8-source-tree.md]
    - `ProductRepository`: `server/src/main/kotlin/com/example/mygroceries/db/` [Source: architecture/8-source-tree.md]
    - `ProductService`: `server/src/main/kotlin/com/example/mygroceries/service/`
    - `ProductRoutes`: `server/src/main/kotlin/com/example/mygroceries/routes/` [Source: architecture/8-source-tree.md]

- **Testing**:
    - Unit tests for `ProductService`
    - Integration tests for API endpoints
    - Test data setup using test fixtures
    - Test coverage for success and error cases

- **Technical Constraints**:
    - Language: Kotlin 1.9.23 [Source: architecture/3-tech-stack.md]
    - Core Framework: Kotlin Multiplatform 1.6.10 [Source: architecture/3-tech-stack.md]
    - Database: PostgreSQL with Exposed ORM [Source: architecture/3-tech-stack.md]
    - JSON Serialization: Kotlinx Serialization [Source: architecture/3-tech-stack.md]
    - Testing: Kotest, MockK [Source: architecture/9-test-strategy-and-standards.md]

## Testing
- **Test File Location**:
    - Unit tests: `server/src/test/kotlin/com/example/mygroceries/service/ProductServiceTest.kt`
    - Integration tests: `server/src/intTest/kotlin/com/example/mygroceries/routes/ProductRoutesTest.kt`

- **Test Standards**:
    - Follow existing test patterns from Category CRUD implementation [Source: Story 1.3]
    - Use Kotest for assertions [Source: architecture/9-test-strategy-and-standards.md]
    - Use MockK for mocking dependencies [Source: architecture/9-test-strategy-and-standards.md]
    - Test both success and error scenarios
    - Include validation tests for all constraints

- **Test Coverage Requirements**:
    - 100% line coverage for `ProductService`
    - All API endpoints covered by integration tests
    - All validation rules tested
    - Edge cases (e.g., non-existent category, invalid UUID format) tested

## Change Log
| Date       | Version | Description                         | Author          |
|------------|---------|-------------------------------------|-----------------|
| 2025-12-17 | 1.0     | Initial story creation              | Scrum Master    |
