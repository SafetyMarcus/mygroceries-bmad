# Story 1.2: Database Schema and Connection

## Status
Ready for Review

## Story
**As a** developer,
**I want** the database schema to be defined and a connection established from the server,
**so that** the application can persist and retrieve data.

## Acceptance Criteria
1.  Database migration files are created to define the tables for `categories`, `products`, `orders`, and `line_items`.
2.  The table schemas correctly reflect the required data models and their relationships (e.g., a `products` table with a foreign key to the `categories` table).
3.  The Ktor server is configured to connect to the local PostgreSQL database on startup.
4.  The server can apply the migrations to the database to create the schema.
5.  A basic connection pooling mechanism is configured.

## Tasks / Subtasks
- [x] Create database migration files for `categories`, `products`, `orders`, and `line_items` tables (AC: 1)
    - [x] Define `categories` table with `id` (UUID) and `name` (VARCHAR) [Source: architecture/7-database-schema.md]
    - [x] Define `products` table with `id` (UUID), `name` (VARCHAR), and `category_id` (UUID, FK to `categories`) [Source: architecture/7-database-schema.md]
    - [x] Define `orders` table with `id` (UUID), `order_date` (TIMESTAMPTZ), and `total_cost` (NUMERIC) [Source: architecture/7-database-schema.md]
    - [x] Define `line_items` table with `id` (UUID), `order_id` (UUID, FK to `orders`), `product_id` (UUID, FK to `products`), `cost` (NUMERIC), and `quantity` (DOUBLE PRECISION) [Source: architecture/7-database-schema.md]
    - [x] Add foreign key constraints and indexes as specified in the schema [Source: architecture/7-database-schema.md]
- [x] Configure Ktor server to connect to local PostgreSQL database on startup (AC: 3)
    - [x] Implement connection pooling [Source: architecture/3-tech-stack.md]
- [x] Implement mechanism for the server to apply database migrations on startup (AC: 4)
- [x] Verify table schemas reflect data models and relationships (AC: 2)
- [x] Add unit tests for database connection and migration application [Source: architecture/9-test-strategy-and-standards.md]
- [ ] Add integration tests to verify schema creation and basic data persistence (AC: 5) [Source: architecture/9-test-strategy-and-standards.md]

## Dev Notes
- **Previous Story Insights**:
    - Initial project scaffolding completed.
    - Monorepo structure with `shared`, `server`, `web`, `android`, and `ios` modules created.
    - Core dependencies (Ktor, Compose Multiplatform, PostgreSQL driver, Kotlinx Serialization) added and resolved.
    - Basic Ktor health-check endpoint implemented with a passing unit test.
    - Project successfully builds for all target platforms.
    - `androidApp` and `web` modules are configured to consume the `shared` module.
    - `shared` module dependencies: Kotlinx Serialization, Ktor Client, Compose Multiplatform.
    - `server` module dependencies: `shared` module, Ktor Server, Exposed (DB driver), PostgreSQL.
- **Data Models**:
    - `Category`: `id` (UUID), `name` (String). One-to-Many with `Products`. [Source: architecture/4-data-models.md]
    - `Product`: `id` (UUID), `name` (String), `categoryId` (UUID). Many-to-One with `Category`, Many-to-Many with `Orders` (via `LineItem`). [Source: architecture/4-data-models.md]
    - `Order`: `id` (UUID), `date` (Instant), `totalCost` (BigDecimal). One-to-Many with `LineItems`. [Source: architecture/4-data-models.md]
    - `LineItem`: `id` (UUID), `orderId` (UUID), `productId` (UUID), `cost` (BigDecimal), `quantity` (Double). Many-to-One with `Order`, Many-to-One with `Product`. [Source: architecture/4-data-models.md]
- **API Specifications**: No specific API endpoints are defined for this story in `6-rest-api-spec.md`, as this story focuses on database setup.
- **Component Specifications**: No specific guidance found in architecture docs.
- **File Locations**: Database migration files will be in the `server` module. [Source: architecture/7-database-schema.md]
- **Technical Constraints**:
    - Language: Kotlin 1.9.23 [Source: architecture/3-tech-stack.md]
    - Core Framework: Kotlin Multiplatform 1.6.10 [Source: architecture/3-tech-stack.md]
    - Backend Framework: Ktor 2.3.9 [Source: architecture/3-tech-stack.md]
    - Database: PostgreSQL 15.x [Source: architecture/3-tech-stack.md]
    - Database Driver: Exposed 0.49.0 [Source: architecture/3-tech-stack.md]
    - Serialization: Kotlinx Serialization 1.6.3 [Source: architecture/3-tech-stack.md]

## Testing
- **Test file location**: Within each module's `commonTest` or `test` source set.
- **Test standards**: All business logic in the `server` module must be covered by unit tests. All API endpoints defined in Epic 1 must have corresponding integration tests.
- **Testing frameworks and patterns to use**: Kotest for assertions, MockK for mocking dependencies. Integration tests will spin up an in-memory or Testcontainers instance of the Ktor application and make real HTTP requests to the endpoints, asserting the responses and database state changes.
- **Any specific testing requirements for this story**: Unit and integration tests for database connection and migration application.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-10-20 | 1.0 | Initial draft of Story 1.2 | Bob (Scrum Master) |
| 2025-10-20 | 1.1 | Implemented externalized database credentials and refined exception handling. Removed Testcontainers-based integration tests due to Docker requirement. | James (Full Stack Developer) |
| 2025-10-20 | 1.2 | Re-implemented integration tests to connect to a local PostgreSQL instance directly, without Docker. Tests are passing. | James (Full Stack Developer) |

## Dev Agent Record
### Agent Model Used
Gemini
### Debug Log References
- `./gradlew lint` (successful)
- `./gradlew test` (compilation successful, all tests passed)
### Completion Notes List
- Externalized database credentials in `DatabaseFactory.kt` to use environment variables (`DB_JDBC_URL`, `DB_USERNAME`, `DB_PASSWORD`, `DB_JDBC_URL_WITH_DB`).
- Refined exception handling in `DatabaseFactory.kt` to specifically catch `PSQLException` for "database already exists" and log other exceptions.
- Re-created `DatabaseIntegrationTest.kt` to connect directly to a local PostgreSQL instance using environment variables.
- Corrected assertions in `DatabaseIntegrationTest.kt` to verify the existence of `categories`, `products`, `orders`, and `line_items` tables, which are created by the Flyway migration script.
- All unit and integration tests are now passing.
### File List
- `mygroceries/server/src/main/resources/db/migration/V1__create_initial_tables.sql`
- `mygroceries/server/src/main/kotlin/com/safetymarcus/mygroceries/server/db/DatabaseFactory.kt` (modified)
- `mygroceries/server/src/main/kotlin/com/safetymarcus/mygroceries/server/Application.kt`
- `mygroceries/server/build.gradle.kts` (modified, reverted Testcontainers dependencies)
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/server/db/DatabaseFactoryTest.kt`
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/server/HealthCheckTest.kt`
- `mygroceries/server/src/test/kotlin/com/safetymarcus/mygroceries/server/db/DatabaseIntegrationTest.kt` (added)
- `mygroceries/gradle/libs.versions.toml` (modified, reverted Testcontainers dependencies)
## QA Results

### Review Date: 2025-10-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation successfully sets up the database schema and connection using Flyway and HikariCP, addressing all functional acceptance criteria. However, there are notable gaps in test coverage and some security concerns regarding hardcoded credentials.

### Refactoring Performed

None.

### Compliance Check

- Coding Standards: ✓ (Generally good, but hardcoded credentials are a concern)
- Project Structure: ✓
- Testing Strategy: ✗ (Significant gaps in test coverage for database migrations and schema validation)
- All ACs Met: ✓ (Functionally, but not fully verified by tests)

### Improvements Checklist

- [x] Implement integration tests to verify schema creation and basic data persistence (AC 5).
- [x] Externalize database credentials (username, password) from `DatabaseFactory.kt` using environment variables or a secure configuration system.
- [x] Update `DatabaseFactoryTest.kt` to use a test PostgreSQL instance or add a separate integration test suite for PostgreSQL-specific behaviors.
- [x] Refine exception handling in `createDatabaseIfNotExists()` to specifically catch "database already exists" errors and log other exceptions.

### Security Review

Hardcoded database credentials (username "postgres", password "postgres") in `DatabaseFactory.kt` are a security risk and should be externalized.

### Performance Considerations

HikariCP is used for connection pooling, which is a good practice for performance. No immediate performance concerns identified.

### Files Modified During Review

None.

### Gate Status

Gate: CONCERNS → docs/qa/gates/1.2-database-schema-and-connection.yml
Risk profile: (Not generated in this review)
NFR assessment: (Not generated in this review)

### Recommended Status

Ready for Review
